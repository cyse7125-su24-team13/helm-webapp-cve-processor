pipeline {
    agent any

    environment {
        GITHUB_CREDENTIALS = credentials('github-token') // The credentials ID containing 'username:token'
        GITHUB_REPO = 'cyse7125-su24-team13/helm-webapp-cve-processor'
        GITHUB_API_URL = 'https://api.github.com'
        NODE_VERSION = '20.x' // Specify the required Node.js version
    }

    parameters {
        string(name: 'GIT_COMMIT_ID', defaultValue: '', description: 'The commit ID to use for the release')
    }

    stages {
        stage('Extract GitHub Token') {
            steps {
                script {
                    def credentialsParts = GITHUB_CREDENTIALS.split(':')
                    if (credentialsParts.length != 2) {
                        error 'Invalid GitHub credentials format. Expected format: username:token'
                    }
                    env.GITHUB_TOKEN = credentialsParts[1]
                }
            }
        }

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Install Node.js and Dependencies') {
            steps {
                sh '''
                    # Install Node.js from NodeSource
                    curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION} | sudo -E bash -
                    sudo apt-get install -y nodejs

                    # Verify Node.js and npm versions
                    node -v
                    npm -v

                    # Install Helm if it's not already installed
                    if ! command -v helm &> /dev/null
                    then
                        echo "Helm not found, installing..."
                        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
                    else
                        echo "Helm is already installed."
                    fi

                    npm install semantic-release@latest \
                                @semantic-release/changelog@latest \
                                @semantic-release/commit-analyzer@latest \
                                @semantic-release/release-notes-generator@latest \
                                @semantic-release/git@latest \
                                @semantic-release/github@latest --legacy-peer-deps

                '''
            }
        }

        stage('Semantic Release') {
            steps {
                script {
                    echo "Running semantic-release..."
                    def result = sh(script: "npx semantic-release", returnStatus: true)
                    if (result != 0) {
                        error "Semantic release failed with exit code: ${result}"
                    }
                }
            }
        }

        stage('Update Chart Version') {
            steps {
                script {
                    echo "Updating Chart version..."
                    // Capture the next version from the semantic-release dry-run output
                    def newVersion = sh(script: "npx semantic-release --dry-run | grep 'next release version' | sed 's/.*: //'", returnStdout: true).trim()
                    if (newVersion) {
                        echo "New version: ${newVersion}"
                        sh "sed -i 's/^version:.*/version: ${newVersion}/' charts/cve-processor/Chart.yaml"
                        sh "git add charts/cve-processor/Chart.yaml"
                        sh "git commit -m 'chore(release): ${newVersion} [skip ci]'"
                        withCredentials([usernamePassword(credentialsId: 'github-token', usernameVariable: 'GITHUB_USER', passwordVariable: 'GITHUB_PASSWORD')]) {
                            sh """
                                git config user.name "${GITHUB_USER}"
                                git config user.email "your-email@example.com"
                                git push https://${GITHUB_USER}:${GITHUB_PASSWORD}@github.com/cyse7125-su24-team13/helm-webapp-cve-processor.git main
                            """
                        }
                    } else {
                        echo "No new version found. Skipping Chart version update."
                    }
                }
            }
        }



        stage('Create GitHub Release') {
            steps {
                script {
                    echo "Creating GitHub release..."
                    def newVersion = sh(script: "npx -c 'semantic-release --dry-run' | grep -Po '(?<=Next release version: )[^\\s]*'", returnStdout: true).trim()
                    echo "New version for release: ${newVersion}"
                    sh "helm package charts/cve-processor --version ${newVersion} --destination ./releases"
                    sh "github-release release --user cyse7125-su24-team13 --repo helm-webapp-cve-processor --tag v${newVersion} --name 'v${newVersion}' --description 'Release of version ${newVersion}' --pre-release=false --file ./releases/cve-processor-${newVersion}.tgz"
                }
            }
        }
    }

    post {
        failure {
            script {
                def status = 'failure'
                def description = 'Post-merge pipeline failed.'
                notifyGithub(params.GIT_COMMIT_ID, status, description)
            }
        }

        success {
            script {
                def status = 'success'
                def description = 'Post-merge pipeline successful.'
                notifyGithub(params.GIT_COMMIT_ID, status, description)
            }
        }
    }
}

def notifyGithub(commitId, status, description) {
    def context = 'post-merge'
    def url = "${env.GITHUB_API_URL}/repos/${env.GITHUB_REPO}/statuses/${commitId}"

    def payload = [
        state       : status,
        target_url  : env.BUILD_URL,
        description : description,
        context     : context
    ]

    def response = sh(
        script: """#!/bin/bash
        curl -s -H "Authorization: token ${env.GITHUB_TOKEN}" \\
             -H "Content-Type: application/json" \\
             -d '${groovy.json.JsonOutput.toJson(payload)}' \\
             ${url}
        """,
        returnStdout: true
    ).trim()

    echo "GitHub API response: ${response}"
}
